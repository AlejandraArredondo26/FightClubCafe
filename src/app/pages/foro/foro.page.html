<app-header titulo="Foro"></app-header>

<ion-content class="ion-padding">

  <!-- Título -->
  <div class="header">
    <h2 class="title">Foro Comunitario</h2>
    <p class="subtitle">Comparte tus ideas con la comunidad</p>
  </div>

  <!-- FORMULARIO PARA CREAR NUEVO COMENTARIO (solo si está logueado) -->
  <ion-card *ngIf="usuarioActualId && threadForm">
    <ion-card-header>
      <ion-card-title>Nuevo comentario</ion-card-title>
    </ion-card-header>

    <ion-card-content>

      <form [formGroup]="threadForm" (ngSubmit)="addThread()">

        <ion-item>
          <ion-label>
            Publicando como:
            <b>{{ usuarioActualNombre }}</b>
          </ion-label>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Comentario</ion-label>
          <ion-textarea formControlName="text" autoGrow="true"></ion-textarea>
        </ion-item>

        <ion-button expand="block" type="submit" [disabled]="threadForm.invalid">
          Publicar
        </ion-button>

      </form>

    </ion-card-content>
  </ion-card>

  <!-- MENSAJE SI NO ESTÁ LOGUEADO -->
  <ion-card *ngIf="!usuarioActualId">
    <ion-card-content>
      <p style="text-align:center; font-size:15px;">
        Debes iniciar sesión para comentar o responder.
      </p>
      <ion-button expand="block" routerLink="/login">Iniciar sesión</ion-button>
    </ion-card-content>
  </ion-card>

  <!-- LISTA DE HILOS DEL FORO -->
  <ion-list *ngIf="threads.length; else emptyState">
    <ion-item-divider color="light">Comentarios recientes</ion-item-divider>

    <ng-container *ngFor="let t of threads">

      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ t.nombre }}</ion-card-title>
          <ion-card-subtitle>
            {{ t.createdAt | date:'short' }}
          </ion-card-subtitle>
        </ion-card-header>

        <ion-card-content>
          <p>{{ t.comentario }}</p>

          <!-- BOTÓN RESPONDER -->
          <ion-button size="small" fill="clear"
                      (click)="toggleReplyForm(t)"
                      [disabled]="!usuarioActualId">
            <ion-icon slot="start" name="arrow-undo-outline"></ion-icon>
            Responder
          </ion-button>

          <!-- mensaje si no está logueado -->
          <ion-note color="medium" *ngIf="!usuarioActualId">
            Debes iniciar sesión para responder.
          </ion-note>

          <!-- FORMULARIO DE RESPUESTA -->
          <form *ngIf="t.ui.showReplyForm"
                [formGroup]="replyForm"
                (ngSubmit)="addReply(t)">

            <ion-item>
              <ion-label>
                Respondiendo como:
                <b>{{ usuarioActualNombre }}</b>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Tu respuesta</ion-label>
              <ion-textarea formControlName="text" autoGrow="true"></ion-textarea>
            </ion-item>

            <ion-button expand="block" type="submit" [disabled]="replyForm.invalid">
              Enviar respuesta
            </ion-button>

          </form>

          <!-- RESPUESTAS -->
          <ion-list *ngIf="getRespuestas(t.id).length">
            <ion-item *ngFor="let r of getRespuestas(t.id)">
              <ion-label>
                <h3>{{ r.nombre }}</h3>
                <p>{{ r.texto }}</p>
                <small>{{ r.createdAt | date:'short' }}</small>
              </ion-label>
            </ion-item>
          </ion-list>

        </ion-card-content>
      </ion-card>

    </ng-container>
  </ion-list>

  <!-- NO HAY COMENTARIOS -->
  <ng-template #emptyState>
    <div class="empty">
      <ion-icon name="chatbubbles-outline"></ion-icon>
      <p>No hay comentarios aún.</p>
      <small>¡Sé el primero en comentar!</small>
    </div>
  </ng-template>

</ion-content>
